# Slack Processor Setup Guide

The Slack processor allows CronAI to send AI-generated responses directly to Slack channels. It supports two methods: OAuth tokens (using the Slack Web API) and incoming webhooks.

## Setup Methods

### Method 1: Incoming Webhooks (Recommended for Simple Use Cases)

Incoming webhooks are the easiest way to get started with Slack integration.

#### Step 1: Create an Incoming Webhook

1. Go to [Slack Messaging Webhooks](https://api.slack.com/messaging/webhooks)
2. Click "Create your Slack app"
3. Choose "From scratch"
4. Enter an app name (e.g., "CronAI")
5. Select your workspace
6. Click "Create App"

#### Step 2: Enable Incoming Webhooks

1. In the left sidebar, click "Incoming Webhooks"
2. Toggle "Activate Incoming Webhooks" to "On"
3. Click "Add New Webhook to Workspace"
4. Select the channel where you want to post messages
5. Click "Allow"

#### Step 3: Configure CronAI

Copy the webhook URL and set it as an environment variable:

```bash
export SLACK_WEBHOOK_URL="https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX"
```

#### Step 4: Test the Configuration

```bash
cronai run --model claude --prompt test_prompt --processor slack:#general
```

### Method 2: OAuth Token (Recommended for Advanced Use Cases)

OAuth tokens provide more flexibility and features, including the ability to post to different channels dynamically.

#### Step 1: Create a Slack App

1. Go to [Slack Apps](https://api.slack.com/apps)
2. Click "Create New App"
3. Choose "From scratch"
4. Enter an app name (e.g., "CronAI")
5. Select your workspace
6. Click "Create App"

#### Step 2: Configure OAuth Scopes

1. In the left sidebar, click "OAuth & Permissions"
2. Scroll down to "Scopes" section
3. Under "Bot Token Scopes", add the following scopes:
   - `chat:write` - Send messages as the bot
   - `chat:write.public` - Send messages to channels the bot isn't a member of

#### Step 3: Install the App

1. Scroll up to "OAuth Tokens for Your Workspace"
2. Click "Install to Workspace"
3. Review the permissions and click "Allow"
4. Copy the "Bot User OAuth Token" (starts with `xoxb-`)

#### Step 4: Configure CronAI

Set the OAuth token as an environment variable:

```bash
export SLACK_TOKEN="xoxb-1234567890123-1234567890123-abcdefghijklmnopqrstuvwx"
```

#### Step 5: Invite the Bot to Channels (Optional)

For private channels, you'll need to invite the bot:

```text
/invite @CronAI
```

For public channels, the bot can post directly if it has the `chat:write.public` scope.

## Configuration Options

### Environment Variables

| Variable | Description | Required | Method |
|----------|-------------|----------|--------|
| `SLACK_TOKEN` | Bot User OAuth Token | ✓ | OAuth |
| `SLACK_WEBHOOK_URL` | Incoming Webhook URL | ✓ | Webhook |

**Note**: You only need to set ONE of these variables, not both.

### CronAI Configuration File

Add Slack processor entries to your `cronai.config` file:

```text
# Using webhook method
0 9 * * 1 claude weekly_report slack:#general

# Using OAuth method (requires SLACK_TOKEN)
0 */6 * * * claude system_health slack:#monitoring

# With variables
0 8 1 * * claude monthly_report slack:#reports reportType=Monthly,department=Engineering
```

## Message Templates

CronAI includes built-in templates for Slack messages:

### Default Template

- Used for regular prompts
- Creates a formatted message with blocks

### Monitoring Template

- Automatically used for prompts containing "monitor", "alert", or "health"
- Includes alert-style formatting
- Uses different visual styling to indicate urgency

### Custom Templates

You can create custom templates in your `templates/` directory:

```json
{
  "blocks": [
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*{{.PromptName}}*\n\n{{.Content}}"
      }
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "Generated by {{.Model}} at {{.Timestamp.Format \"15:04\"}}"
        }
      ]
    }
  ]
}
```

## Troubleshooting

### Common Issues

#### "channel_not_found" Error

- For private channels, ensure the bot is invited to the channel
- For OAuth method, verify the bot has proper scopes
- Check that the channel name includes the `#` prefix

#### "invalid_auth" Error

- Verify the `SLACK_TOKEN` is correct and starts with `xoxb-`
- Ensure the token hasn't expired
- Check that the app is still installed in your workspace

#### "missing_scope" Error

- The bot token is missing required OAuth scopes
- Re-configure the app with `chat:write` and `chat:write.public` scopes
- Reinstall the app to workspace

#### Webhook "invalid_payload" Error

- The webhook URL might be incorrect
- Check that the webhook is still active in your Slack app settings
- Verify the JSON payload is properly formatted

### Testing

#### Test Webhook Connection

```bash
curl -X POST -H 'Content-type: application/json' \
    --data '{"text":"Test from CronAI"}' \
    $SLACK_WEBHOOK_URL
```

#### Test OAuth Token

```bash
curl -H "Authorization: Bearer $SLACK_TOKEN" \
    -H "Content-Type: application/json" \
    -X POST \
    -d '{"channel":"#general","text":"Test from CronAI"}' \
    https://slack.com/api/chat.postMessage
```

## Security Considerations

### Webhook URLs

- Webhook URLs are sensitive and should be kept secure
- Don't commit webhook URLs to version control
- Rotate webhook URLs if they become compromised

### OAuth Tokens

- Bot tokens should be treated like passwords
- Store tokens in environment variables, not in code
- Use workspace-scoped tokens, not user tokens
- Monitor token usage in Slack's audit logs

### Channel Permissions

- Be mindful of which channels the bot can access
- Use private channels for sensitive information
- Consider creating dedicated channels for CronAI notifications

## Advanced Features

### Dynamic Channel Routing

With OAuth tokens, you can route different types of messages to different channels:

```text
# System alerts to monitoring channel
0 */5 * * * claude system_check slack:#monitoring

# Reports to team channel  
0 9 * * 1 claude weekly_report slack:#team-updates

# Errors to alerts channel
0 * * * * claude error_check slack:#alerts
```

### Message Formatting

Slack supports rich message formatting with blocks and attachments. The default templates use Slack's Block Kit for better visual presentation.

### Rate Limiting

Slack has rate limits for API calls:

- Webhook URLs: Generally more permissive
- OAuth API: Tier-based rate limiting

CronAI respects these limits and will retry failed requests with exponential backoff.

## Support

For issues specific to Slack integration:

1. Check the Slack app's logs in the Slack API console
2. Verify environment variables are set correctly
3. Test the connection using the troubleshooting commands above
4. Check CronAI logs for detailed error messages

For CronAI-specific issues, see the main troubleshooting documentation.
